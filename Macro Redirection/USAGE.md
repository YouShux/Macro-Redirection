# Macro Redirection - 使用说明

## 快速开始

### 1. 安装插件

将编译后的 DLL 文件放入 Dalamud 插件目录：
```
%APPDATA%\XIVLauncher\devPlugins\MacroRedirection\
```

### 2. 启用插件

在游戏中使用命令 `/xlplugins` 打开插件列表，找到并启用 "Macro Redirection"。

### 3. 打开配置

使用以下任一命令打开配置窗口：
- `/macroredirect`
- `/mr`

## 配置示例

### 示例 1：治疗职业鼠标悬停施法

**场景**: 白魔法师想要通过鼠标悬停队友来释放治疗技能

**配置步骤**:
1. 打开配置窗口（`/mr`）
2. 选择 "WHM"（白魔法师）
3. 找到 "医治" 技能
4. 点击 "添加重定向"
5. 设置目标优先级为：
   - UI Mouseover（列表悬停优先）
   - Model Mouseover（场景模型悬停次之）
   - Target（最后使用当前目标）

**效果**: 当你按下医治技能时，插件会按顺序尝试：
1. 如果鼠标悬停在列表上 → 对悬停的队友施放
2. 如果鼠标悬停在场景中的队友模型上 → 对该队友施放
3. 否则 → 对当前选中目标施放

### 示例 2：DPS 职业的范围技能优化

**场景**: 龙骑士想要使用鼠标位置释放地面技能

**配置步骤**:
1. 选择 "DRG"（龙骑士）
2. 找到地面技能（如 "破碎冲"）
3. 添加重定向
4. 设置目标优先级：
   - Cursor（光标位置）

**效果**: 技能会直接在光标位置释放，无需显示范围指示器。

### 示例 3：使用修饰键的多目标配置

**场景**: 学者想要为 "鼓舞激励之策" 设置两种不同的施放模式

**配置步骤**:
1. 选择 "SCH"（学者）
2. 找到 "鼓舞激励之策"
3. 添加两个重定向配置：

**配置 A**（无修饰键）:
- 修饰键：None
- 目标优先级：UI Mouseover → Target

**配置 B**（按住 Shift）:
- 修饰键：Shift
- 目标优先级：Focus → Self

**效果**:
- 正常按技能 → 对悬停或选中目标施放
- 按住 Shift + 技能 → 对焦点目标施放，如无焦点则对自己施放

## 常见问题

### Q: 技能没有重定向效果？

**A**: 检查以下几点：
1. 确认插件已启用
2. 确认在配置中为该技能添加了重定向
3. 确认当前职业与配置的职业匹配
4. 检查目标优先级列表是否正确

### Q: 显示"目标不在范围内"？

**A**: 有两个解决方案：
1. 在 "选项" → "重定向选项" 中勾选 "忽略范围和目标类型错误"
2. 调整技能的目标优先级，移除超出范围的目标

### Q: 如何为所有治疗技能启用鼠标悬停？

**A**:
1. 在 "选项" → "默认鼠标悬停行为" 中勾选 "友方技能默认悬停"
2. 这样无需为每个技能单独配置，所有友方技能都会自动使用鼠标悬停

### Q: 技能图标不显示？

**A**:
1. 在 "显示" 菜单中确认 "显示技能图标" 已勾选
2. 可以调整 "图标缩放" 来改变图标大小

### Q: 与其他鼠标悬停插件冲突？

**A**:
- 本插件与其他类似插件可能存在冲突
- 建议禁用其他鼠标悬停/重定向插件，只使用一个
- 或者为不同的技能使用不同的插件

## 高级技巧

### 技巧 1：快速设置职能技能

如果你在多个职业上都想使用相同的职能技能配置（如"真北"、"亲疏自行"等）：

1. 选择 "职能技能"
2. 为职能技能设置重定向
3. 这些配置会应用到所有能使用该职能技能的职业

### 技巧 2：利用软目标功能

"Soft Target"（软目标）是游戏中的一个隐藏目标系统：

- 在不改变当前目标的情况下，可以通过键鼠操作选择软目标
- 适合需要快速切换目标的场景
- 在目标优先级中添加 "Soft Target" 可以利用这个功能

### 技巧 3：队伍成员占位符的妙用

使用 `<2>` ~ `<8>` 占位符可以直接对队伍中特定位置的成员施放技能：

- `<2>` = 队伍列表第2位
- `<3>` = 队伍列表第3位
- 以此类推...

**应用场景**:
- 固定队的治疗职业可以为特定队友设置专属技能快捷方式
- 例如为MT设置 `<2>` 优先的减伤技能

### 技巧 4：地面技能的智能释放

对于地面技能（如召唤师的"痛苦流"），可以设置多层目标：

1. Cursor - 优先在光标位置
2. Target - 如果没有有效光标位置，在目标脚下
3. Self - 最后在自己脚下

这样可以应对不同的战斗场景。

## 性能优化建议

1. **不要设置过多的目标优先级**
   - 每个技能建议不超过 3-4 个目标
   - 过多的目标检查会影响性能

2. **合理使用默认行为**
   - 如果大部分技能都需要鼠标悬停，使用全局默认设置
   - 只为特殊技能设置单独的重定向

3. **定期清理无用配置**
   - 职业改版后，及时删除已废弃技能的配置
   - 保持配置列表整洁

## 与 YouShu ACR 联动示例

如果你使用 YouShu 的 ACR，可以让 ACR 获取本插件的配置：

```csharp
// 在 YouShu ACR 的循环中
var ipc = Services.Interface.GetIpcSubscriber<uint, bool>("MacroRedirection.IsActionRetargeted");
try
{
    // 检查治疗技能是否被重定向
    if (ipc.InvokeFunc(技能ID))
    {
        // 技能已配置重定向，ACR 可以选择不处理目标选择
        // 直接使用默认目标即可，由 Macro Redirection 处理
        return 技能ID;
    }
    else
    {
        // 技能没有重定向配置，ACR 需要自己选择目标
        var 目标 = SelectBestTarget();
        return (技能ID, 目标);
    }
}
catch
{
    // Macro Redirection 未安装，使用 ACR 默认逻辑
}
```

## 故障排除

### 插件加载失败

1. 检查 Dalamud 版本是否最新
2. 查看 `/xllog` 中的错误日志
3. 确认 .NET 10.0 运行时已安装
4. 尝试重新编译插件

### 技能施放异常

1. 禁用本插件，测试是否为插件导致
2. 检查游戏宏设置是否冲突
3. 查看插件日志（`/xllog`）获取详细错误信息
4. 尝试重置配置（删除配置文件并重启）

### IPC 通信失败

1. 确认目标插件（如 YouShu）已正确安装
2. 检查 IPC 接口名称是否正确
3. 查看双方插件的日志输出
4. 尝试重启游戏重新加载插件

---

如有其他问题，请查阅 README.md 或联系插件作者。
